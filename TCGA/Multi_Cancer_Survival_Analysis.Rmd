```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

# 1. Environment Setup

## 1.1 Load Required Libraries
```{r load-libraries}
# Data manipulation and analysis
library(dplyr)
library(tidyverse)
library(data.table)

# Survival analysis
library(survival)
library(survminer)

# Genomic data handling
library(recount3)
library(biomaRt)
library(TCGAbiolinks)
library(SummarizedExperiment)
library(DESeq2)
library(GenomicFeatures)
library(rtracklayer)

# Matrix operations and utilities
library(matrixStats)
library(sparseMatrixStats)
library(viridis)
```

## 1.2 Create Directory Structure
```{r create-dirs}
# Create necessary directories if they don't exist
dirs <- c("results", "cache", "logs")
sapply(dirs, dir.create, showWarnings = FALSE)
```

# 2. Configuration

```{r config}
# Set the cancer type you want to analyze
CANCER_TYPE <- "BRCA"  # Change this to analyze different cancer types

# Analysis parameters
ANALYSIS_PARAMS <- list(
  gene = "SRRM3",
  data_type = "PSI",  # or "expression"
  grouping_method = "quartile"
)

# Print configuration
cat("Analysis Configuration:\n")
cat("Cancer Type:", CANCER_TYPE, "\n")
cat("Gene:", ANALYSIS_PARAMS$gene, "\n")
cat("Data Type:", ANALYSIS_PARAMS$data_type, "\n")
cat("Grouping Method:", ANALYSIS_PARAMS$grouping_method, "\n")
```

# 3. Data Retrieval and Processing

## 3.1 Clinical Data
```{r get-clinical}
# Source the get_clinical_data function from the original script
source("Multi_Cancer_Survival_Analysis.R")

# Get clinical data
clinical_data <- get_clinical_data(CANCER_TYPE)

# Display summary of clinical data
summary(clinical_data)

# Plot basic survival curve for all patients
fit_all <- survfit(Surv(overall_survival, deceased) ~ 1, data = clinical_data)
ggsurvplot(fit_all, 
           data = clinical_data,
           title = paste("Overall survival in", CANCER_TYPE),
           risk.table = TRUE)
```

## 3.2 Molecular Data
```{r get-molecular}
# Get molecular data based on analysis type
molecular_data <- if(ANALYSIS_PARAMS$data_type == "PSI") {
  get_psi_data(CANCER_TYPE, ANALYSIS_PARAMS$gene)
} else {
  get_expression_data(CANCER_TYPE, ANALYSIS_PARAMS$gene)
}

# Display summary statistics
summary(molecular_data)

# Plot distribution of molecular values
ggplot(molecular_data, aes(x = if(ANALYSIS_PARAMS$data_type == "PSI") psi else expression)) +
  geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7) +
  theme_minimal() +
  labs(title = paste(ANALYSIS_PARAMS$gene, ANALYSIS_PARAMS$data_type, "Distribution in", CANCER_TYPE),
       x = if(ANALYSIS_PARAMS$data_type == "PSI") "PSI Value" else "Expression Value",
       y = "Count")
```

# 4. Data Integration and Analysis

## 4.1 Merge Clinical and Molecular Data
```{r merge-data}
# Prepare data for merging
clinical_data$merge_id <- substr(clinical_data$case_id, 1, 12)
molecular_data$merge_id <- substr(molecular_data$case_id, 1, 12)

# Merge data
merged_data <- inner_join(clinical_data, molecular_data, by = "merge_id")

# Print summary of merged dataset
cat("Samples before merging:\n")
cat("Clinical:", nrow(clinical_data), "\n")
cat("Molecular:", nrow(molecular_data), "\n")
cat("After merging:", nrow(merged_data), "\n")
```

## 4.2 Sample Grouping
```{r group-samples}
# Group samples based on molecular values
value_col <- if(ANALYSIS_PARAMS$data_type == "PSI") "psi" else "expression"

if (ANALYSIS_PARAMS$grouping_method == "quartile") {
  quartiles <- quantile(merged_data[[value_col]], probs = c(0.25, 0.75), na.rm = TRUE)
  merged_data$group <- case_when(
    merged_data[[value_col]] <= quartiles[1] ~ "Low",
    merged_data[[value_col]] >= quartiles[2] ~ "High",
    TRUE ~ "Medium"
  )
}

# Display group sizes
table(merged_data$group)

# Plot value distribution by group
ggplot(merged_data, aes(x = group, y = .data[[value_col]], fill = group)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = paste("Distribution of", ANALYSIS_PARAMS$gene, 
                    ANALYSIS_PARAMS$data_type, "by Group"),
       y = if(ANALYSIS_PARAMS$data_type == "PSI") "PSI Value" else "Expression Value")
```

# 5. Survival Analysis

## 5.1 Kaplan-Meier Analysis
```{r survival-analysis}
# Perform survival analysis
fit <- survfit(Surv(time = overall_survival, event = deceased) ~ group, 
               data = merged_data)

# Create survival plot
survival_plot <- ggsurvplot(
  fit,
  data = merged_data,
  pval = TRUE,
  risk.table = TRUE,
  tables.height = 0.3,
  title = sprintf("%s survival by %s %s", 
                 CANCER_TYPE, ANALYSIS_PARAMS$gene, 
                 ANALYSIS_PARAMS$data_type)
)

print(survival_plot)
```

## 5.2 Cox Proportional Hazards Model
```{r cox-model}
# Fit Cox model
cox_model <- coxph(Surv(time = overall_survival, event = deceased) ~ group, 
                   data = merged_data)

# Print model summary
summary(cox_model)

# Test proportional hazards assumption
ph_test <- cox.zph(cox_model)
print(ph_test)
plot(ph_test)
```

# 6. Save Results
```{r save-results}
# Create results directory for this analysis
results_dir <- file.path("results", paste0(CANCER_TYPE, "_analysis"))
dir.create(results_dir, showWarnings = FALSE)

# Save plots
ggsave(file.path(results_dir, "survival_plot.pdf"), 
       plot = survival_plot$plot, 
       width = 10, height = 8)

# Save data
saveRDS(list(
  clinical_data = clinical_data,
  molecular_data = molecular_data,
  merged_data = merged_data,
  survival_fit = fit,
  cox_model = cox_model
), file.path(results_dir, "analysis_results.rds"))

# Save summary statistics
write.csv(summary(cox_model)$coefficients, 
          file.path(results_dir, "cox_model_summary.csv"))
```

This notebook provides an interactive environment for exploring the TCGA data and survival analysis for a specific cancer type. You can:

1. Change the `CANCER_TYPE` variable to analyze different cancers
2. Modify analysis parameters in the `ANALYSIS_PARAMS` list
3. Examine data at each step with additional visualizations
4. Add more analyses as needed

To use this notebook:

1. Save it as `Multi_Cancer_Survival_Analysis.Rmd` in your TCGA directory
2. Make sure the original `Multi_Cancer_Survival_Analysis.R` script is in the same directory
3. Open it in RStudio and run chunks sequentially to explore the data and analysis

The notebook includes data quality checks, visualizations, and detailed analysis steps that will help you understand the data and results better than running the entire analysis at once.
